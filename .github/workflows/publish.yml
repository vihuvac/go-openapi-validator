name: Publish to pkg.go.dev

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Optional semver to release (e.g. 1.2.3). If omitted, topmost version in CHANGELOG.md is used."
        required: false
      dry_run:
        description: "If true, run checks but do not create or push the tag."
        required: false
        default: "false"
  workflow_run:
    workflows:
      - "Go Test & Coverage"
    types:
      - completed
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  prepare_release:
    name: Prepare release (automated)
    if: "github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'"
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Ensure CHANGELOG.md changed in merge commit
        run: |
          set -euo pipefail
          SHA='${{ github.event.workflow_run.head_sha }}'
          echo "Checking commit $SHA for CHANGELOG.md changes"
          if ! git show --name-only --pretty="" "$SHA" | grep -qx "CHANGELOG.md"; then
            echo "CHANGELOG.md not changed in this merge. Skipping release.";
            exit 1
          fi

      - name: Create release tag
        id: create
        uses: ./.github/actions/create-release-tag

  manual_release:
    name: Manual release (requires approval)
    if: "github.event_name == 'workflow_dispatch'"
    environment:
      name: "release"
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release tag
        id: create
        uses: ./.github/actions/create-release-tag
        with:
          version: ${{ github.event.inputs.version }}
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}

  publish_after_prepare:
    name: Notify Go Proxy (automated)
    if: "needs.prepare_release.outputs.tag != ''"
    needs: [prepare_release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Notify Go Proxy
        uses: ./.github/actions/notify-proxy
        with:
          tag: ${{ needs.prepare_release.outputs.tag }}

  publish_after_manual:
    name: Notify Go Proxy (manual)
    if: "needs.manual_release.outputs.tag != ''"
    needs: [manual_release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Notify Go Proxy
        uses: ./.github/actions/notify-proxy
        with:
          tag: ${{ needs.manual_release.outputs.tag }}

  publish_on_push:
    name: Notify Go Proxy (tag push)
    if: "github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Notify Go Proxy
        uses: ./.github/actions/notify-proxy
        with:
          tag: ${{ github.ref_name }}
