name: Publish to pkg.go.dev

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Optional semver to release (e.g. 1.2.3). If omitted, topmost version in CHANGELOG.md is used."
        required: false
      dry_run:
        description: "If true, run checks but do not create or push the tag."
        required: false
        default: "false"
  workflow_run:
    workflows:
      - "Go Test & Coverage"
    types:
      - completed
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  prepare_release:
    name: Create tag from CHANGELOG
    if: "github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'"
    runs-on: ubuntu-latest
    outputs:
      tag_created: ${{ steps.tag_check.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Ensure CHANGELOG.md changed in merge commit
        id: changelog_check
        run: |
          set -euo pipefail
          SHA='${{ github.event.workflow_run.head_sha }}'
          echo "Checking commit $SHA for CHANGELOG.md changes"
          if git show --name-only --pretty="" "$SHA" | grep -qx "CHANGELOG.md"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "CHANGELOG.md not changed in this merge. Skipping release.";
            exit 0
          fi

      - name: Create release tag
        uses: ./.github/actions/create-release-tag

      - name: Check if tag was created
        id: tag_check
        run: echo "created=true" >> "$GITHUB_OUTPUT"

  manual_release:
    name: Manual release (requires approval)
    if: "github.event_name == 'workflow_dispatch'"
    environment:
      name: "release"
    runs-on: ubuntu-latest
    outputs:
      tag_created: ${{ steps.tag_check.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release tag
        uses: ./.github/actions/create-release-tag
        with:
          version: ${{ github.event.inputs.version }}
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}

      - name: Check if tag was created
        id: tag_check
        run: |
          # Tag is created unless dry_run=true or error occurred
          dry_run="${{ github.event.inputs.dry_run }}"
          if [ "${dry_run:-false}" = "true" ] || [ "${dry_run:-false}" = "True" ]; then
            echo "created=false" >> "$GITHUB_OUTPUT"
          else
            echo "created=true" >> "$GITHUB_OUTPUT"
          fi

  publish:
    name: Notify Go Proxy
    if: "(needs.prepare_release.outputs.tag_created == 'true') || (needs.manual_release.outputs.tag_created == 'true')"
    needs: [prepare_release, manual_release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify Go Proxy
        env:
          GITHUB_REF: ${{ github.ref }}
        run: |
          MODULE_PATH=$(go list -m)
          TAG=${GITHUB_REF#refs/tags/}
          echo "Publishing $MODULE_PATH@$TAG"
          curl -fSLo /dev/null https://proxy.golang.org/$MODULE_PATH/@v/$TAG.info || true
